version: 2.1

workflows:  # Collection of jobs orchestrated to run in a specific order
  version: 2.1
  poc:
    jobs:
      - kubectl-poc

jobs:  # Collection of commands needed to accomplish a specific task
  kubectl-poc:
    docker:
      - image: cimg/node:15.11.0
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    steps:
      - run:
          name: Create minimal kubeconfig for Service Account
          command: |
            export DECODED_TOKEN=$(echo ${GKE_SERVICE_ACCOUNT_TOKEN} | base64 -d)
            echo $CERTIFICATE_AUTHORITY_DATA | base64 -d > ca.crt
            kubectl config set-cluster $CLUSTER_NAME --server=$SERVER_IP --certificate-authority=ca.crt
            kubectl config set-credentials $CLUSTER_USER --token=${DECODED_TOKEN}
            kubectl config set-context circleci --user=$CLUSTER_USER --namespace=default --cluster=$CLUSTER_NAME
            kubectl config use-context circleci
      - run: kubectl get pods
