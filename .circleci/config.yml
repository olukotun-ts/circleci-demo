version: 2.1

orbs: 
  continuation: circleci/continuation@0.2.0
  
workflows:  # Collection of jobs orchestrated to run in a specific order
  version: 2.1
  build-test-deploy:
    jobs:
      - add-context
      - continuation/continue:
          configuration_path: ./continue-config.yml
          requires:
            - add-context

jobs:  # Collection of commands needed to accomplish a specific task
  add-context:
    docker:
      - image: cimg/node:15.11.0
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    steps:
      - run:
          name: Add context to do-deploy job
          command: |
            # Todo: Check if CIRCLE_BRANCH == "master" && CIRCLE_JOB == "do-deploy"
            brew install yq
            yq eval --inplace '.workflows.build-test-deploy.jobs[0].context[0] = strenv($MASTER_CONTEXT)' .circleci/continue-config.yml
  