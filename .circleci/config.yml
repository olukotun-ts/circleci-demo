version: 2.1

workflows:  # Collection of jobs orchestrated to run in a specific order
  version: 2.1
  build_test_and_deploy:
    jobs:
      - test
      # - build
      # - deploy-staging:
      #     requires:
      #       - test
      #       - build
      # - promote-to-prod:
      #     type: approval
      #     requires:
      #       - deploy-staging
      # - deploy-prod:
      #     requires:
      #       - promote-to-prod

jobs:  # Collection of commands needed to accomplish a specific task
  build:
    docker:  # CircleCI supports Docker, Linux, Windows, and macOS
      - image: circleci/node:10.15
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    resource_class: large  # Options range from small to 2xlarge+
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true  # DLC will cache layers and avoid rebuilding unchanged ones
      - run:
          name: Log in to Docker Hub
          command: echo "$DOCKER_PASS" | docker login -u $DOCKER_USER --password-stdin
      - run: 
          name: Build Docker image
          command: docker build -t olukotunts/app:$CIRCLE_SHA1 .
      - run:
          name: Push Docker image to Docker Hub
          command: docker push olukotunts/app:$CIRCLE_SHA1
  test:
    docker:
      - image: circleci/node:10.15
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS    
    steps:
      - checkout
      # - run: npm install
      # - run: npm test
      - run: for remote in `git branch -r | grep -vE "HEAD|master"`; do git branch --track $remote; done
      - run: |
          CHILD_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          PARENT_BRANCH=$(git show-branch | sed "s/].*//" | grep "\*" | grep -v "$(git rev-parse --abbrev-ref HEAD)" | head -n1 | sed "s/^.*\[//")
          if [ "$CHILD_BRANCH" = "$PARENT_BRANCH" ]; then
            echo "Can't merge branch into itself! Skipping."
            exit 0
          fi
      - run: echo $CHILD_BRANCH
      - run: echo $PARENT_BRANCH
  deploy-staging:
    docker:
      - image: circleci/node:10.15
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Log in to Docker Hub
          command: echo "$DOCKER_PASS" | docker login -u $DOCKER_USER --password-stdin
      - run:
          name: Pull Docker image from Docker Hub
          command: docker pull olukotunts/app:$CIRCLE_SHA1
      - run:
          name: Install Heroku CLI
          command: curl https://cli-assets.heroku.com/install.sh | sh
      - run:
          name: Log in to Heroku Container Registry
          command: heroku container:login
      - run:
          name: Tag Docker image
          command: docker tag olukotunts/app:$CIRCLE_SHA1 registry.heroku.com/name-button-staging/web
      - run:
          name: Push Docker image to Heroku
          command: docker push registry.heroku.com/name-button-staging/web
      - run:
          name: Deploy Docker image to Heroku
          command: heroku container:release --app name-button-staging web
  deploy-prod:
    docker:
      - image: circleci/node:10.15
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Log in to Docker Hub
          command: echo "$DOCKER_PASS" | docker login -u $DOCKER_USER --password-stdin
      - run:
          name: Pull Docker image from Docker Hub
          command: docker pull olukotunts/app:$CIRCLE_SHA1
      - run:
          name: Install Heroku CLI
          command: curl https://cli-assets.heroku.com/install.sh | sh
      - run:
          name: Log in to Heroku Container Registry
          command: heroku container:login
      - run:
          name: Tag Docker image
          command: docker tag olukotunts/app:$CIRCLE_SHA1 registry.heroku.com/name-button/web
      - run:
          name: Push Docker image to Heroku
          command: docker push registry.heroku.com/name-button/web
      - run:
          name: Deploy Docker image to Heroku
          command: heroku container:release --app name-button web
